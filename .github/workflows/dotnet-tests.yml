name: .NET Tests

on:
  workflow_call:
    inputs:
      runs-on:
        required: true
        type: string
      vs-version:
        required: true
        type: string
      dotnet-version:
        required: true
        type: string

jobs:
  test:
    runs-on: ${{ inputs.runs-on }}

    steps:
    - uses: actions/checkout@v4
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ inputs.dotnet-version }}

    - name: Add msbuild to PATH
      uses: microsoft/setup-msbuild@v2
      with:
        vs-version: ${{ inputs.vs-version }}

    - name: Build
      run: dotnet build DotNetBuildable.slnf /p:Configuration=Release

    - name: Create global.json to enforce .NET 8 for MSBuild and update Tests/TestData projects
      if: inputs.dotnet-version == '8.0.x'
      shell: pwsh
      run: |
        # ensure .NET 8 SDK is used for MSBuild operations
        '{"sdk":{"version":"8.0.0","rollForward":"latestFeature"}}' | Out-File -FilePath global.json -Encoding utf8
        Write-Host "Updating <TargetFramework>net10.0...</TargetFramework> entries to net8.0 under Tests/TestData"

        # Replace net10.0 and net10.0-windows with net8.0 / net8.0-windows respectively
        $projFiles = Get-ChildItem -Path Tests/TestData -Recurse -Include *.csproj,*.vbproj,*.fsproj -ErrorAction SilentlyContinue
        foreach ($f in $projFiles) {
          $path = $f.FullName
          $content = Get-Content -Path $path -Raw -ErrorAction Stop
          $updated = $content -replace '<TargetFramework>net10.0(-windows)?</TargetFramework>', '<TargetFramework>net8.0$1</TargetFramework>'
          if ($updated -ne $content) {
            Write-Host "Updating: $path"
            $updated | Set-Content -Path $path -Encoding utf8
          }
        }

        # If any files were changed, commit them so the working tree is clean for subsequent test steps.
        $status = git status --porcelain
        if ($status) {
          git config user.name "github-actions[bot]"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git add -A
          git commit -m "CI: Update Tests/TestData TargetFramework -> net8.0 for .NET 8 run" || Write-Host "git commit returned non-zero (possibly no staged changes)"
          Write-Host "Committed changes to local repo (not pushed)."
        } else {
          Write-Host "No project files needed updating."
        }

    - name: Log MSBuild version
      run: msbuild -version

    - name: Log .NET version
      run: dotnet --info

    - name: Execute unit tests
      run: dotnet test Tests/Tests.csproj -c Release --framework net${{ inputs.dotnet-version == '8.0.x' && '8.0' || '10.0' }} --no-build
